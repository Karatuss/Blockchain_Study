# 7 web3와 채널 Dapp

:bulb: <span style='background-color:#fff5b1'>**web3**를 사용해 **Dapp**의 거의 모든 것을 자동화 할 수 있다.</span>

:bulb: <span style='background-color:#fff5b1'>**web3 API/web3**는 블록체인 함수를 액세스하기 위한 포괄적 패키지이다.</span>

:bulb: <span style='background-color:#fff5b1'>web3는 애플리케이션이 이더리움 블록체인 클라이언트 노드가 제공하느 서비스에 액세스할 수 있도록하는 *(일반적으로 web3로 통칭되는)* 자바스크립트 라이브러리다.</span>

:exclamation: **web3** - 전체 라이브러리 web3.js / **Web3** - web3.js에서 사용되는 클래스명

---
---

## 7.1 wbe3 API

:bulb: **web3 API**는 탈중앙화 애플리케이션의 모든 참여자가 **같은 구문과 의미**로 블록체인과 상호작용할 수 있도록 하는 함수와 클래스의 표준적 집합이다.

:bulb: **web3 API**는 해싱을 위한 표준적 함수를 제공함으로써, 모든 참여자가 같은 데이터에 대해 같은 해시값을 얻을 수 있도록 하며, **일관성 있는 연산**을 가능하게 한다.


### 7.1.1 Dapp 스택에서의 web3

:question: Dapp 스택 어디에 web3가 등장할까?

:heavy_check_mark: web3가 제공하는 함수는 두 개의 카테고리로 나뉜다.

:one: 블록체인 노드의 코어 오퍼레이션을 지원하는 함수들

:two: 블록체인상에 탈중앙화 애플리케이션 스택을 가능하게 하는 함수들

<img width="258" alt="그림 7 1" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/a4aa1521-575c-4770-8fc2-e0e86ab0437e">


- 그림 7.1의 상단 부분은 **애플리케이션 모듈**을 보여주는데, 웹 서버와 app.js에 있는 애플리케이션 코드를 포함한다.
- 그림 7.1의 하단 부분은 **블록체인 클라이언트 노드 모듈**인데, 코어 블록 체인 서비스를 제공한다.
- 그림 7.1의 스택 레이어 
  - 스택의 맨 위 레이어는 웹 클라이언트로 블록체인 서비스가 필요한 모든 클라이언트를 의미한다.
  - 그 다음 레이어에서는 웹 애플리케이션의 app.js가 web3.js 라이브러리를 이용해 블록체인 서비스에 액세스한다.
  - 그 아래 레이어에는 전통적인 웹 서버이고 클라이언트 리퀘스트를 처리한다. *(Node.js 서버를 사용해 구현한다.)*
  - web3.js은 app.js 애플리케이션 로직이 블록체인 노드의 web3 프로바이더에 연결할 수 있도록 한다.
- 그림 7.1에서 블록체인 노드는 web3에서 정의한 클래스와 함수를 호스팅해주기 때문에 **web3프로바이더**라고 불린다.


:boom: <span style='color:orange'>그림 7.1은 전형적인 Dapp 스택의 아키텍처 개요로, 이것을 글로벌 플라스틱 제거 문제를 다루는 마이크로 페이먼트 채널을 개발하기 위한 가이드라인으로 사용할 수 있다.</span>

### 7.1.2 wbe3 패키지

- web3 API는 여러가지 기능을 가진 다수의 패키지로 구성된다.
- 그림 7.2는 core, eht, net, proviers, shh, utils 여섯개의 패키지를 보여준다. *(이 장에서는 **web3.eth, web3.providers, web3.utils**을 사용한다.)*
  - **eht 패키지와 서브 패키지**는 애플리케이션이 어카운트, 스마트 컨트랙트와 상호작용할 수 있도록 한다.
  - **providers 패키지**는 가나쉬 같은 특정한 web3 프로바이더를 설정할 수 있도록 한다.
  - **utils 패키지**는 Dapp을 위한 표준적이며 공통적인 유틸리티 함수들을 제공한다.

    <img width="299" alt="그림 7 2" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/67491842-c7fd-4776-8470-2f79d8a6d52e">


   - web3.core : 블록체인 오퍼레이션을 위한 코어 프로토콜을 구현
   - web3.net : 트랜잭션을 브로드캐스팅하고 수신하는 네트워크 측면을 담당
   - web3.shh : 위스퍼 프로토콜이라는 P2P 메시징 기능을 위한 것

- **web3 API**
  -  web3.js 라이브러리가 제공하는 모든 클래스와 서브 클래스를 사용할 수 있게 한다.
  - RPC 포트를 통해 로컬 노드와의 통신을 지원한다.
  - web3.eht를 통해 eht 객체에 액세스한다.
  - web3.net과 그 함수를 통해 네트워크 객체에 액세스 할 수 있도록 한다.

:heavy_check_mark: <span style='background-color:#dcffe4'>블록체인 애플리케이션 개발 시 여러 레벨에서 web3가 어떻게 작동하는지 완벽히 이해해야 한다.</span>

<img width="263" alt="그림 7 3" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/aa6e2b8f-d5d6-430e-ba75-bc890bd10064">

- 그림 7.3은 그림 7.1을 개선한 것으로 하나의 애플리케이션 내에서 어떻게 web3를 사용하는지를 보여준다.
- web3 프로바이더는 web3 API를 구현한다.
- 애플리케이션의 app.js는 web3 프로바이더의 함수 호출을 통해 블록체인 클라이언트 노드를 액세스하고 상호작용한다.

:boom: <span style='color:orange'>7.2-7.3에서 web3 개념을 적용하고 시연하기 위해, 채널 개념과 글로벌 플라스틱 청소를 위한 마이크로 페이먼트 채널 Dapp을 설명하고, 종단 간 구현을 해볼 것이다.</span>


---
---

## 7.2 채널 개념


<span style='color:#10f0f0'> **블록체인 기술을 이용하는 다양한 사람들이 참여할 수 있는 마이크로 페이먼트 채널을 만들어 볼 것이다.**</span>

- **채널**이란 정보가 하나의 포인트에서 다른 포인트로 지나가는 경로다.
  - 이 장에서는 지급 메커니즘을 위해 채널을 사용한다.
  - **페이먼트 채널**로도 많이 알려져 있다.
  - 이더리움에서는 신뢰하는 파티 간의 오프체인 트랜잭션을 위한 스테이트 채널로 사용된다.
   
<span style='color:pink'>:one:
페이먼트 채널은 한 어카운트에서 다른 어카운트로 지급을 하기 위한 수단이다.
:two: 
사이드 채널은 오프체인 수단으로서, 스마트 컨트랙트, 해싱 함수, 암호학적 사인, 아이덴티티 관리 같은 온체인 블록체인 기능을 이용해서 구현한다.
</span>

---
---

## 7.3 마이크로 페이먼트 채널

- 마이크로 페이먼트는 전 세계에 걸쳐 이어져 온 오래된 관행이다.
- 이런 페이먼트는 은행과 같은 통상적인 금융기관을 거치지 않는다.
- 비트코인 블록체인은 서로 모르는 피어들 간에 온라인으로 송금할 수 있는 기능을 제공함으로써 이러한 상황을 바꾸었다.


:heavy_exclamation_mark: 마이크로 페이먼트 채널에 대한 몇가지 기본적인 사항
- 송신자와 수신자의 어카운트 주소로 식별하는 엔드포인트로 정의한다.
- 송신자와 수신자 간의 빈번한 소액(마이크로) 지급을 수월하게 만들어 준다.
- 지급 금액은 메인 채널의 트랜잭션에 부과되는 트랜잭션 수수료보다 작다(이 경우 메인 채널은 사용할 수 없다).
- 송신자와 수신자의 관계는 임시적이며, 통상적으로 지급 정산을 하고 메인 채널과의 싱크 완료시 이 관계는 종료된다.
  
<img width="291" alt="그림 7 4" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/757aba8a-5a2d-4396-80e4-a0b2b0e2618d">
- 그림 7.4는 이러한 개념과 두 어카운트 간에 존재하는 온체인 메인 채널과 오프체인 사이드 채널의 관계를 보여준다.
  
    **:one: 메인 채널**
    - 누구나 메인 채널에 참여하거나 떠날 수 있고, 서로 아무 어카운트와 트랜잭션을 처리할 수 있다.
    - 모든 메인 채널상의 트랜잭션은 블록체인에 기록된다.
    - 메인 채널은 비트코인과 이더리움의 메인 체인처럼 영구적이다.

    **:two: 사이드 채널**
    - 마이크로 페이먼트 채널은 선정된 어카운트(여기선 두 어카운트)간의 사이드 채널의 예라고 볼 수 있다.
    - 사이드 채널 어카운트 간의 트랜잭션은 오프체인에서 일어나며, 메인 체인과 싱크가 되기 전까지는 체인에 기록되지 않는다.
    - 이런 동기화는 사이드 채널에 참여하고 있는 한 사용자가 트랜잭션을 메인 채널에 보낼 때 일어나는데, 이때 오프체인 트랜잭션 정보를 캡처해서 요약해 보낸다.

---
---

## 7.4 마이크로 페이먼트 채널 유스 케이스
:mag_right: <span style = 'background-color:yellow'>글로벌 재활용 가능 플라스틱 문제 - 마이크로 페이먼트 채널을 활용할 실제 문제를 가정해 보자.</span>
- 완벽한 탈중앙화 문제이자, 글로벌한 범위를 가지고 있다.
- 참여자들은 탈중앙화되어 있으며, 서로를 알지 못할 수도 있다.
- 이 Dapp을 표현하기 위해 MPC라는 약자를 사용하자.

:bulb: <span style = 'color:pink'> UN과 같은 비정부기구가 전 세계에 걸쳐 재활용 가능한 플라스틱을 수집하는 행위에 대해 소액을 지급하는 (마이크로 페이먼트) 인센티브 프로그램을 운영한다고 가정하자. 수집한 플라스틱은 상자당 계산하며, 재활용과 적절한 폐기 처리를 위한 시설로 보낸다. 쉽게 이 프로세스를 처리할 수 있는 탈중앙화 애플리케이션을 설계하고 개발해보자. </span>


### 7.4.1 전통적인 은행 솔루션

<img width="293" alt="그림 7 5" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/2ef75b22-8c21-4d42-b93c-1e97fc297416">

- 그림 7.5는 대량의 탈중앙화된 글로벌 스케일 플라스틱 수거 작업을 위한 지급 시스템을 통상적인 은행 시스템을 사용해 해결해 보려는 솔루션이다.
- 이 솔루션은 은행 계좌가 없는 작업자들에게도 소액 지급이 가능한 새로운 지급 시스템을 만들기 위해 전통적인 은행 시스템을 사용해 본 것이다.
---
:question: <span style = 'background-color : yellow'>이 솔루션은 블록체인을 사용한 접근 방법에 비해 몇가지 중요한 문제가 있다.</span>
- 표 7.1은 어카운트 생성, 소액 지급과 같은 문제를 부각시키고, 전통적인 시스템이 어디에서 한계에 부딪히는지, 블록체인 솔루션은 이러한 문제를 어떻게 명쾌하게 해결하는지 설명한다.
<img width="296" alt="표 7 1" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/99963ef5-5a86-475f-89eb-397ed490d50f">

---

:exclamation: <span style = 'background-color : yellow'> 두 가지 접근 방법을 비교해보자. </span>
- 그림 7.6은 그림 7.5의 모델을 블록체인 기반 마이크로 페이먼트 솔루션을 사용해 개선해 본 것이다.
- 그림 7.6에 두 시스템 간의 차리를 강조해서 나타냈다.
<img width="301" alt="그림 7 6" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/625e5fed-6c90-498e-841c-2bdbfee23473">


:star: <span style = 'color : #a2e4b8'> **전통적 시스템과 블록체인 솔루션의 가장 중요한 차이는 스마트 컨트랙트가 은행을 대체하고, 디지털 마이크로 페이먼트가 지급 수표를 대체하는 것이다.** </span>

- 작업자가 누적된 최종 마이크로 페이먼트에 대해 지급 요청을 하면, 해당 컨트랙트는 파괴 또는 종료가 되는데, 이것은 많은 수의 수표 발행으로 인한 비용 문제를 해결할 뿐만 아니라, 부정한 이중 지급을 방지한다.
- MPC 애플리케이션에 종이로 된 수표는 존재하지 않는다.
- 이 애플리케이션은 탈중앙화된 참여자에게 온라인 디지털 마이크로 페이먼트를 보낼 수 있는 안전한 메커니즘이다.

### 7.4.2 사용자와 역할
- MPC-Dapp의 사용자는 수거 작업에 대해 지급을 하는 주관자와 재활용 가능한 플라스틱을 수거하는 작업자다.
- 누구나 작업자가 될 수 있다.
- MPC가 요구하는 기술은 플라스틱 쓰레기를 수거해서 지정장소에 갖다주는 것뿐이다.
- 전 세계의 누구나 블록체인 아이덴티티를 가질 수 있는 사람은 이 작업에 동참할 수 있다.
- 은행 계좌도 필요없다.
- 여기서 이 어카운트 넘버는 이더리움 블록체인 주소이다.
  
### 7.4.3 온체인과 오프체인 오퍼레이션
- 온체인과 오프체인 오퍼레이션을 더 잘 이해하기 위해 MPC 문제를 한 번 더 분석해보자.
- 오퍼레이션
  1. 마이크로 페이먼트 채널 개설
  2. 플라스틱 수거
  3. 수거 확인
  4. 마이크로 페이먼트 지급
  5. 지급 요청
  6. 채널 종료
- MPC 배포, 지급 요청을 위한 오퍼레이션(1, 5, 6)은 온체인에서 이루어지고 스마트 컨트랙트 설계를 규정한다.
- 오퍼레이션(2, 3, 4)는 오프체인에서 이루어진다.

<img width="302" alt="그림 7 7" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/55754945-8c5d-4706-bb73-344d261fd8dd">

### 7.4.4 MPC 스마트 컨트랙트 (MPC-contract)
<img width="300" alt="그림 7 8" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/a2301044-e6d7-4dfb-8890-c1e8c6fbba30">
- 컨트랙트는 constructor 함수를 포함해 두 개의 퍼블릭 함수를 가진다.
- 이 함수들은 그림 7.7의 분석에서 식별한 두 개의 온체인 오퍼레이션(1, 5)을 코드로 구현한 것이다.
  - **constructor는 주관자가 스마트 컨트랙트를 배포할 수 있도록 한다.**
  - **claimPayment() 함수는 작업자가 지급을 요청할 때 호출된다.**
    - claimPayment()는 작업자가 보낸 모든 데이터를 검증한다.
    - 여기서는 송신자의 시그니처만을 검증한다.
    - isValidSignature(), recoverSigner(), splitSignature(), prefixed(), ecreover() 등이 호출된다.
    - 이런 다수의 함수가 관여하는 검증 프로세서는 아무나 참여하고 이탈할 수 있는 블록체인과 자동화된 검증 시스템을 위해 반드시 필요하다.
  
  - 전통적인 은행의 역할을 스마트 컨트랙트로 대체하고 나면, 전통적인 시스템이 사용하던 여러가지 부정 방지와 남용을 예방하는 수단을 대체할 암호학적 함수들이 필요하다.

- 리스트 7.1의 스마트 컨트랙트 코드를 통해 새로운 패러다임을 리뷰해본다.
  - **온체인 오퍼레이션**
    - 1: 스마트 컨트랙트는 채널을 오픈한다.
    - 5: 지급 요청에 대해 지급한다.
    - 6: 채널을 종료한다.
  - 오프체인 파트에서 수행해야 할 작업들 중에 제일 중요한 것은 작업자가 수거한 쓰레기의 상자의 확인을 마쳤을 때 마이크로 페이먼트에 사인을 하는 것이고, 이는 Dapp의 MPC-app 모듈이 담당해야 한다.
  
:question: <span style = 'color:#ff6666'> **왜 스마트 컨트랙트를 파기하는가?** </span>
- 왜 지급 전송을 하고 난 후 스마트 컨트랙트를 파기하는가?
- 빈 병을 수고하고 그 대가로 몇 센트를 받는 사람을 가정하자
  - 이를 위해 은행 계좌 오픈 안할 것
  - 돈을 받고 나서 이를 지급한 기계에 대해 기억하고 내역을 추적할 필요도 없을 것
  - 탈중앙화 채널에서도 작업자가 지급 요청을 하는 것 외에는 작업자에게 다른 오버헤드를 지우고 싶지 않을 것
  - 같은 마이크로 페이먼트를 반복적으로 재지급하고 싶지 않을 것


  <span style = 'color : orange'>:arrow_forward: 이것이 스마트 컨트랙트가 주관자와 작업자간의 채널이 임시적이어야 하는 이유다. </span>

<span style = 'color : pink'> **:star: 이러한 임시적 채널 개념은 전통적인 프로그래밍에서는 볼 수 없었던 새로운 개념이지만, 스마트 컨트랙트를 이용한 블록 체인 프로그램을 설계할 때 기억해야할 기념이다.**
</span>
### 7.4.5 MPC 애플리케이션 개발(MPC-app)
- Dapp의 오프체인 파트인 MPC-app 개발
  - 여기에 유저 인터페이스도 있다.
- 그림 7.7의 2, 3, 4 중에서 MPC-Dapp 예제에서 다룰 것은 오직 마이크로 페이먼트 디지털 서명 부분(4)뿐이다.
  - MPC-Dapp의 매우 중요한 부분이자, 서로 모르는 사람들이 참여하는 블록체인 기반 디지털 네트워크에서 매우 유용하게 사용될 디지털 서명 프로세스
  
:exclamation: <span style = 'color:#ff6666'> **디지털 서명** </span>
- 디지털 서명이란?
  - 일반적인 은행 수표 : 금액, 은행 정보, 송신자 정보, 수신자 정보, 수표 정보, 송신자의 시그니처
  - 스마트 컨트랙트의 주소로 은행 정보 대체
  - 송신자의 어카운트의 고유한 논스로 수표 번호 대체
  - 블록체인 트랜잭션의 타임스태프로 전통적인 수표의 날짜 대체
- 블록체인 과부화를 방지하기 위해 최소한의 데이터만 저장하는 것이 좋다.
  
<img width="293" alt="그림 7 9" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/3ca00dfd-d3ea-4625-840f-a3637c06abe7">

- 메시지는 사인을 하기 전에 고정 크기로 해시한다.
  - 하나의 메시지 안에 몇 개의 아이템들을 패킹하고 있는지, 또는 각 메시지의 크기에 상관없이 메시지는 고유한 256비트의 값으로 해시한다.
  - **디지털 서명 오퍼레이션**은 이 해시값을 송신자의 개인키로 암호화한다.
  - 메타마스크는 이 해시값을 안전하게 사인할 수 있도록 도와준다.
- 해싱과 사인을 하는 MPC-app의 app.js 코드에서 constructPaymentMessage()함수가 메시지 요소의 해싱을 담당하고, signMessage() 함수는 사인을 처리한다.

<img width="224" alt="그림 7 10" src="https://github.com/TwoPair/Blockchain_Study/assets/51403372/edb2ac8f-5b60-467c-8c17-d366a70009c6">
- 그림 7.10은 사인을 확정하기 위한 메타마스크 창을 나타낸 것이다.
